# Recommendations App

This Django app provides a robust recommendation system for client-nest, integrating with the ML microservice to deliver personalized recommendations and churn predictions.

## Features

- **User Interaction Tracking**: Logs user interactions for recommendation algorithms
- **Multi-Algorithm Recommendations**: Collaborative, content-based, and hybrid filtering
- **Churn Prediction**: Identifies users at risk of churning
- **Feedback Collection**: Tracks user feedback on recommendations
- **Analytics Dashboard**: Provides insights into recommendation performance

## Models

### UserInteraction
Tracks user interactions with content:
- `user`: ForeignKey to User
- `interaction_type`: Type of interaction (view, like, comment, share, click, ai_usage)
- `content_id`: ID of the content item
- `content_type`: Type of content (post, article, etc.)
- `platform`: Platform where interaction occurred
- `metadata`: Additional interaction data

### Recommendation
Stores recommendations generated by the ML service:
- `user`: ForeignKey to User
- `content_id`: Recommended content ID
- `score`: Recommendation score
- `algorithm`: Algorithm used (collaborative, content, hybrid)
- `is_clicked`: Whether user clicked the recommendation
- `is_dismissed`: Whether user dismissed the recommendation

### ChurnPrediction
Stores churn predictions:
- `user`: ForeignKey to User
- `churn_risk`: Risk score (0-1)
- `features`: Features used for prediction
- `prediction_date`: When prediction was made

## API Endpoints

### GET /api/recommendations/recommendations/
Get recommendations for the authenticated user.

**Query Parameters:**
- `algorithm`: collaborative, content, or hybrid (default: hybrid)
- `top_k`: Number of recommendations (default: 10, max: 50)

**Response:**
```json
{
  "recommendations": [
    {
      "content_id": "123",
      "score": 0.95,
      "algorithm": "hybrid"
    }
  ],
  "algorithm": "hybrid",
  "total_count": 10
}
```

### GET /api/recommendations/churn-prediction/
Get churn prediction for the authenticated user.

**Response:**
```json
{
  "churn_risk": 0.23,
  "risk_level": "low",
  "prediction_date": "2024-01-15T10:30:00Z"
}
```

### POST /api/recommendations/interactions/
Log a user interaction.

**Request Body:**
```json
{
  "interaction_type": "view",
  "content_id": "123",
  "content_type": "post",
  "platform": "web",
  "metadata": {
    "duration": 30,
    "source": "homepage"
  }
}
```

### POST /api/recommendations/feedback/
Provide feedback on a recommendation.

**Request Body:**
```json
{
  "content_id": "123",
  "is_clicked": true,
  "is_dismissed": false
}
```

### GET /api/recommendations/stats/
Get recommendation statistics for the user.

**Response:**
```json
{
  "total_recommendations": 50,
  "clicked_recommendations": 15,
  "dismissed_recommendations": 5,
  "click_through_rate": 0.3,
  "total_interactions": 200,
  "latest_churn_risk": 0.23
}
```

## Integration with ML Service

The app integrates with the ML microservice via HTTP requests:

1. **Data Extraction**: Extracts user interactions and features from Django models
2. **ML Service Call**: Sends data to ML service for recommendations/churn prediction
3. **Response Processing**: Stores results and returns to frontend

### Configuration

Add to Django settings:

```python
# ML Service Configuration
ML_SERVICE_URL = 'http://localhost:8001'  # URL of ML microservice

# Recommendation Settings
RECOMMENDATION_CACHE_TTL = 3600  # Cache recommendations for 1 hour
CHURN_PREDICTION_CACHE_TTL = 86400  # Cache churn predictions for 24 hours
```

## Usage Examples

### Logging User Interactions

```python
from recommendations.services import RecommendationService

service = RecommendationService()

# Log a view interaction
service.log_interaction(
    user_id=123,
    interaction_type='view',
    content_id='post_456',
    content_type='post',
    platform='web',
    metadata={'duration': 45}
)
```

### Getting Recommendations

```python
from recommendations.services import RecommendationService

service = RecommendationService()

# Get hybrid recommendations
recommendations = service.get_recommendations(
    user_id=123,
    algorithm='hybrid',
    top_k=10
)
```

### Churn Prediction

```python
from recommendations.services import RecommendationService

service = RecommendationService()

# Predict churn risk
churn_risk = service.predict_churn(user_id=123)
```

## Frontend Integration

### React/JavaScript Example

```javascript
// Get recommendations
const getRecommendations = async (algorithm = 'hybrid', topK = 10) => {
  const response = await fetch(`/api/recommendations/recommendations/?algorithm=${algorithm}&top_k=${topK}`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  return response.json();
};

// Log interaction
const logInteraction = async (interactionData) => {
  await fetch('/api/recommendations/interactions/', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(interactionData)
  });
};

// Provide feedback
const provideFeedback = async (contentId, isClicked, isDismissed) => {
  await fetch('/api/recommendations/feedback/', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      content_id: contentId,
      is_clicked: isClicked,
      is_dismissed: isDismissed
    })
  });
};
```

## Deployment

1. **Add to INSTALLED_APPS**:
   ```python
   INSTALLED_APPS = [
       # ... other apps
       'recommendations',
   ]
   ```

2. **Run Migrations**:
   ```bash
   python manage.py makemigrations recommendations
   python manage.py migrate
   ```

3. **Start ML Service**:
   ```bash
   cd ml_service
   docker build -t ml_service .
   docker run -p 8001:8000 ml_service
   ```

4. **Configure URLs**:
   ```python
   # In main urls.py
   urlpatterns = [
       # ... other URLs
       path('api/recommendations/', include('recommendations.urls')),
   ]
   ```

## Monitoring and Analytics

The admin interface provides:
- User interaction logs
- Recommendation performance metrics
- Churn prediction history
- Click-through rates and engagement analytics

## Performance Optimization

- **Caching**: Recommendations are cached to reduce ML service calls
- **Database Indexes**: Optimized queries with proper indexing
- **Async Processing**: Heavy operations can be moved to Celery tasks
- **Rate Limiting**: API endpoints include rate limiting for production

## Security Considerations

- **Authentication**: All endpoints require user authentication
- **Data Privacy**: User data is anonymized for ML training
- **Input Validation**: All inputs are validated and sanitized
- **Rate Limiting**: Prevents abuse of recommendation endpoints 